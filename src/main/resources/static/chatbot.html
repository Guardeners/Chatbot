<!doctype html>
<html lang="ko" data-theme="auto">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Chat – App Style</title>
    <style>
        :root{
            --bg:#f3f4f6;           /* page background */
            --surface:#ffffff;       /* card surface */
            --text:#111827;          /* primary text */
            --muted:#6b7280;         /* secondary text */
            --border:#e5e7eb;        /* subtle borders */
            --accent:#2563eb;        /* brand accent */
            --accent-2:#111827;      /* header text/icon */
            --bubble-user:#1f429c;   /* user bubble */
            --bubble-bot:#eef2ff;    /* bot bubble */
            --radius:22px;           /* global radius */
            --shadow:0 10px 25px rgba(0,0,0,.08);
        }
        @media (prefers-color-scheme: dark){
            :root{
                --bg:#0b1220;
                --surface:#0f172a;
                --text:#e5e7eb;
                --muted:#94a3b8;
                --border:#17213a;
                --accent:#60a5fa;
                --accent-2:#e5e7eb;
                --bubble-user:#2444b5;
                --bubble-bot:#1e293b;
                --shadow:0 10px 25px rgba(0,0,0,.35);
            }
        }
        *{box-sizing:border-box}
        html,body{height:100%}
        body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui,"Segoe UI",Roboto,Helvetica,Arial}

        .app{
            position:relative;
            max-width:440px;
            height:100dvh;
            margin:0 auto;
            display:grid;
            grid-template-rows:auto 1fr auto;
            background:var(--surface);
            box-shadow:var(--shadow);
        }

        /* Header */
        .app__header{
            position:sticky; top:0; z-index:10;
            padding:14px 16px 12px;
            background:linear-gradient(120deg, rgba(37,99,235,.1), rgba(99,102,241,.08));
            border-bottom:1px solid var(--border);
            display:flex; align-items:center; gap:10px;
        }
        .app__title{font-weight:700; letter-spacing:.2px}
        .badge{margin-left:auto; font-size:12px; color:var(--muted); border:1px solid var(--border); padding:6px 10px; border-radius:999px}
        .toggle{
            border:none; background:transparent; color:var(--accent-2); padding:6px; border-radius:10px; cursor:pointer;
        }
        .toggle:hover{background:rgba(0,0,0,.06)}

        /* Messages */
        .messages{padding:14px; overflow:auto; -webkit-overflow-scrolling:touch; scroll-behavior:smooth}
        .msg{max-width:80%; margin:8px 0; padding:12px 14px; border-radius:16px; white-space:pre-wrap; word-break:break-word}
        .msg.user{margin-left:auto; background:linear-gradient(135deg, #2563eb, #3b82f6); color:#fff; border-bottom-right-radius:6px}
        .msg.bot{margin-right:auto; background:var(--bubble-bot); border:1px solid var(--border); color:var(--text); border-bottom-left-radius:6px}
        .row{display:flex; gap:8px; align-items:flex-end}
        .avatar{width:28px; height:28px; border-radius:8px; background:linear-gradient(135deg,#1f2937,#111827); flex:0 0 28px}
        .avatar.bot{background:linear-gradient(135deg,#2563eb,#3b82f6)}
        .time{font-size:11px; color:var(--muted); margin:0 6px}

        /* Composer */
        .composer{position:sticky; bottom:0; z-index:10; background:linear-gradient(to top, var(--surface), rgba(0,0,0,0)); padding:10px 12px calc(10px + env(safe-area-inset-bottom)); border-top:1px solid var(--border); display:flex; gap:8px}
        .input{
            flex:1; display:flex; gap:8px; align-items:center; background:var(--surface); border:1px solid var(--border); border-radius:16px; padding:8px 10px 8px 12px;
        }
        .input input{flex:1; border:none; outline:none; background:transparent; color:var(--text)}
        .send{
            display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:0 14px; border:none; border-radius:14px; background:var(--accent); color:#fff; font-weight:600; height:40px; cursor:pointer;
            box-shadow:0 6px 14px rgba(37,99,235,.25);
        }
        .send:disabled{opacity:.5; cursor:not-allowed; box-shadow:none}

        /* Typing dots */
        .typing{display:inline-flex; gap:6px; align-items:center}
        .dot{width:6px; height:6px; border-radius:50%; background:var(--muted); opacity:.6; animation:blink 1s infinite}
        .dot:nth-child(2){animation-delay:.15s}
        .dot:nth-child(3){animation-delay:.3s}
        @keyframes blink{0%{transform:translateY(0); opacity:.4} 50%{transform:translateY(-3px); opacity:1} 100%{transform:translateY(0); opacity:.4}}

        /* Empty state */
        .empty{height:100%; display:flex; align-items:center; justify-content:center; color:var(--muted); text-align:center; padding:40px}
    </style>
</head>
<body>
<div class="app" id="app">
    <div class="app__header">
        <div class="app__title">Chat</div>
        <span class="badge" id="modelBadge">Server default model</span>
        <button class="toggle" id="themeBtn" aria-label="테마 전환">
            <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="4"/><path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M6.34 17.66l1.41-1.41M16.24 7.76l1.41-1.41"/></svg>
        </button>
    </div>

    <div class="messages" id="messages"></div>

    <div class="composer">
        <div class="input">
            <input id="prompt" type="text" placeholder="질문을 입력하세요." autocomplete="off" />
        </div>
        <button class="send" id="send">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
            보내기
        </button>
    </div>
</div>

<script>
    // --- Simple app state ---
    const $messages = document.getElementById('messages');
    const $prompt   = document.getElementById('prompt');
    const $send     = document.getElementById('send');
    const $badge    = document.getElementById('modelBadge');
    const storageKey = 'chat.history.v1';

    let state = { items: [] };

    // Load from sessionStorage
    try{
        const raw = sessionStorage.getItem(storageKey);
        if(raw){ state.items = JSON.parse(raw) || []; }
    }catch(e){ /* ignore */ }

    function save(){ sessionStorage.setItem(storageKey, JSON.stringify(state.items)); }

    function fmtTime(d){
        const t = new Date(d);
        const hh = t.getHours().toString().padStart(2,'0');
        const mm = t.getMinutes().toString().padStart(2,'0');
        return `${hh}:${mm}`;
    }

    function messageRow(item){
        sessionStorage.removeItem(storageKey); //세션저장 안함
        const row = document.createElement('div');
        row.className = 'row';
        const avatar = document.createElement('div');
        avatar.className = 'avatar ' + (item.role === 'user' ? 'user' : 'bot');
        const bubble = document.createElement('div');
        bubble.className = 'msg ' + (item.role === 'user' ? 'user' : 'bot');
        bubble.textContent = item.content;
        const time = document.createElement('div');
        time.className = 'time';
        time.textContent = fmtTime(item.ts || Date.now());

        if(item.role === 'user'){
            row.appendChild(time);
            row.appendChild(bubble);
            row.appendChild(avatar);
        } else {
            row.appendChild(avatar);
            row.appendChild(bubble);
            row.appendChild(time);
        }
        return row;
    }

    function typingRow(){
        const row = document.createElement('div');
        row.className = 'row';
        const avatar = document.createElement('div');
        avatar.className = 'avatar bot';
        const bubble = document.createElement('div');
        bubble.className = 'msg bot';
        const box = document.createElement('div');
        box.className = 'typing';
        box.innerHTML = '<span class="dot"></span><span class="dot"></span><span class="dot"></span>';
        bubble.appendChild(box);
        const time = document.createElement('div');
        time.className = 'time';
        time.textContent = fmtTime(Date.now());
        row.appendChild(avatar); row.appendChild(bubble); row.appendChild(time);
        return row;
    }

    function render(){
        if(!state.items.length){
            $messages.innerHTML = '<div class="empty">대화를 시작해 보세요.</div>';
            return;
        }
        $messages.innerHTML = '';
        state.items.forEach(it => $messages.appendChild(messageRow(it)));
        $messages.scrollTop = $messages.scrollHeight;
    }

    // Optionally set a model label from server default (can be left generic)
    $badge.textContent = 'Server default model';

    async function send(){
        const text = $prompt.value.trim();
        if(!text) return;
        $prompt.value = '';
        $send.disabled = true;

        const user = { role:'user', content:text, ts: Date.now() };
        state.items.push(user); render(); save();

        const typing = typingRow();
        $messages.appendChild(typing); $messages.scrollTop = $messages.scrollHeight;

        try{
            const res = await fetch('/api/chat',{
                method:'POST', headers:{'Content-Type':'application/json'},
                body: JSON.stringify({ prompt: text })
            });
            const data = await res.json();
            typing.remove();
            const content = (data && (data.answer ?? data.content)) || '(응답 없음)';
            const bot = { role:'assistant', content, ts: Date.now() };
            state.items.push(bot); render(); save();
        }catch(e){
            typing.remove();
            const bot = { role:'assistant', content:'[에러] ' + (e.message || e), ts: Date.now() };
            state.items.push(bot); render(); save();
        }finally{
            $send.disabled = false;
            $prompt.focus();
        }
    }

    $send.addEventListener('click', send);
    $prompt.addEventListener('keydown', e => {
        if(e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); send(); }
    });

    // Theme toggle (auto ↔ dark ↔ light)
    const themeBtn = document.getElementById('themeBtn');
    const root = document.documentElement;
    function setTheme(mode){ root.setAttribute('data-theme', mode); localStorage.setItem('theme.mode', mode); }
    function initTheme(){ const saved = localStorage.getItem('theme.mode'); if(saved) root.setAttribute('data-theme', saved); }
    initTheme();
    themeBtn.addEventListener('click', () => {
        const cur = root.getAttribute('data-theme') || 'auto';
        const next = cur === 'auto' ? 'dark' : cur === 'dark' ? 'light' : 'auto';
        setTheme(next);
    });

    render();
</script>
</body>
</html>


