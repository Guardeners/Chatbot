<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Chat – Green App</title>
    <style>
        :root{
            --bg1:#e8f7ec; --bg2:#d7f0e1;           /* page gradient */
            --card:#f8fffb;                         /* phone surface */
            --text:#0f3a2a; --muted:#6b8f7d;        /* text */
            --border:#cfe9da; --header:#ffe59e;     /* ui */
            --shadow:0 18px 40px rgba(22,60,40,.12);
            --user:#1e6b62; --userText:#fff;        /* user bubble */
            --bot:#d9f4e7; --botText:#0f3a2a;       /* bot bubble */
        }
        *{box-sizing:border-box}
        html,body{height:100%}
        body{margin:0;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:var(--text);font:16px/1.45 system-ui,"Segoe UI",Roboto,Helvetica,Arial}

        /* phone */
        .phone{max-width:420px;height:100dvh;margin:0 auto;display:grid;grid-template-rows:auto 1fr auto;background:var(--card);border-radius:28px;box-shadow:var(--shadow);overflow:hidden}

        /* header */
        .header{position:relative;background:var(--header);padding:16px 18px 10px}
        .titleRow{display:flex;align-items:center;gap:10px}
        .dot{width:12px;height:12px;border-radius:50%;background:#2c6a5a;box-shadow:0 0 0 4px rgba(44,106,90,.08)}
        .title{font-weight:800;letter-spacing:.3px}
        .subtitle{margin-top:6px;color:#1b4332;opacity:.8;font-size:14px}

        /* messages */
        .messages{padding:10px 8px 0 10px;overflow:auto;background:linear-gradient(180deg,rgba(255,255,255,.65),rgba(255,255,255,.25))}
        .row{display:flex;gap:8px;align-items:flex-end;margin:8px 0}
        .row.right{justify-content:flex-end; padding-right:4px}

        .avatar{width:44px;height:44px;border-radius:50%;border:3px solid #ecf7f0;box-shadow:0 6px 14px rgba(0,0,0,.08);object-fit:cover;background:#e6f3ec}

        .bubble{display:inline-block;max-width:88%;width:fit-content;min-width:0;padding:12px 15px;border-radius:18px;box-shadow:0 6px 14px rgba(0,0,0,.06);border:1px solid var(--border);white-space:pre-wrap;word-break:break-word}
        .bot{background:var(--bot);color:var(--botText);border-bottom-left-radius:10px}
        .user{background:var(--user);color:var(--userText);border-bottom-right-radius:10px}

        .time{font-size:12px;color:var(--muted);margin:0 6px}

        /* composer */
        .composer{position:sticky;bottom:0;background:linear-gradient(to top,var(--card),rgba(255,255,255,.4));padding:12px 12px calc(12px + env(safe-area-inset-bottom));border-top:1px solid var(--border);display:flex;gap:10px;align-items:center}
        .field{flex:1;display:flex;align-items:center;background:#fff;border:1px solid var(--border);border-radius:22px;padding:10px 14px}
        .input{flex:1;border:none;outline:none;font-size:16px;color:var(--text);background:transparent}
        .fab{width:54px;height:54px;border:none;border-radius:18px;background:#2e7d6a;color:#fff;display:inline-flex;align-items:center;justify-content:center;box-shadow:0 10px 20px rgba(34,94,78,.25);cursor:pointer}
        .fab:disabled{opacity:.6;box-shadow:none;cursor:not-allowed}

        .typing{display:inline-flex;gap:6px;align-items:center}
        .dot3{width:6px;height:6px;border-radius:50%;background:#549d86;opacity:.6;animation:b .9s infinite}
        .dot3:nth-child(2){animation-delay:.15s}
        .dot3:nth-child(3){animation-delay:.3s}
        @keyframes b{0%{transform:translateY(0);opacity:.4}50%{transform:translateY(-3px);opacity:1}100%{transform:translateY(0);opacity:.4}}

        .empty{height:100%;display:flex;align-items:center;justify-content:center;color:var(--muted);text-align:center;padding:40px}
    </style>
</head>
<body>
<div class="phone" id="app">
    <div class="header">
        <div class="titleRow"><div class="dot"></div><div class="title">Chat: 농부와의 대화</div></div>
        <div class="subtitle">오늘의 미션: 커피 줄이기</div>
    </div>

    <div class="messages" id="messages"></div>

    <div class="composer">
        <div class="field">
            <input id="prompt" class="input" type="text" placeholder="질문을 입력하세요..." autocomplete="off" />
        </div>
        <button class="fab" id="send" aria-label="보내기">
            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 20s6-6 6-10a5 5 0 1 0-10 0c0 4 4 6 4 6"/><path d="M12 20s2-3 2-6a5 5 0 1 1 10 0c0 2-2 4-4 5"/></svg>
        </button>
    </div>
</div>

<script>
    const FARMER_SRC = '/farmer.png'; // static 폴더에 farmer.png가 있어야 함

    const $messages = document.getElementById('messages');
    const $prompt   = document.getElementById('prompt');
    const $send     = document.getElementById('send');

    const storageKey = 'chat.history.v1';
    let state = { items: [] };
    try{ sessionStorage.removeItem(storageKey); const raw = sessionStorage.getItem(storageKey); if(raw){ state.items = JSON.parse(raw) || []; } }catch(e){}
    function save(){ sessionStorage.setItem(storageKey, JSON.stringify(state.items)); }

    function t(){ const d=new Date();return `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}` }

    function row(it){
        const r=document.createElement('div'); r.className='row'+(it.role==='user'?' right':'');
        if(it.role==='assistant'){
            const avatar=new Image(); avatar.className='avatar'; avatar.alt='bot'; avatar.src=FARMER_SRC; r.appendChild(avatar);
            const b=document.createElement('div'); b.className='bubble bot'; b.textContent=it.content; r.appendChild(b);
            const tm=document.createElement('div'); tm.className='time'; tm.textContent=it.time||t(); r.appendChild(tm);
        } else {
            const tm=document.createElement('div'); tm.className='time'; tm.textContent=it.time||t(); r.appendChild(tm);
            const b=document.createElement('div'); b.className='bubble user'; b.textContent=it.content; r.appendChild(b);
        }
        return r;
    }

    function typing(){
        const r=document.createElement('div'); r.className='row';
        const avatar=new Image(); avatar.className='avatar'; avatar.alt='bot'; avatar.src=FARMER_SRC; r.appendChild(avatar);
        const b=document.createElement('div'); b.className='bubble bot';
        const dots=document.createElement('div'); dots.className='typing'; dots.innerHTML='<span class="dot3"></span><span class="dot3"></span><span class="dot3"></span>';
        b.appendChild(dots); r.appendChild(b);
        const tm=document.createElement('div'); tm.className='time'; tm.textContent=t(); r.appendChild(tm);
        return r;
    }

    function render(){
        if(!state.items.length){ $messages.innerHTML='<div class="empty">대화를 시작해 보세요.</div>'; return; }
        $messages.innerHTML=''; state.items.forEach(it=> $messages.appendChild(row(it))); $messages.scrollTop=$messages.scrollHeight;
    }

    async function send(){
        const text=$prompt.value.trim(); if(!text) return; $prompt.value=''; $send.disabled=true;
        const mine={role:'user',content:text,time:t()}; state.items.push(mine); render(); save();
        const typ=typing(); $messages.appendChild(typ); $messages.scrollTop=$messages.scrollHeight;
        try{
            const res=await fetch('/api/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({prompt:text})});
            const data=await res.json(); typ.remove();
            const content=(data && (data.answer ?? data.content)) || '(응답 없음)';
            state.items.push({role:'assistant',content,time:t()}); render(); save();
        }catch(e){ typ.remove(); state.items.push({role:'assistant',content:'[에러] '+(e.message||e),time:t()}); render(); save(); }
        finally{ $send.disabled=false; $prompt.focus(); }
    }

    $send.addEventListener('click', send);
    $prompt.addEventListener('keydown', e=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); send(); } });

    render();
</script>
</body>
</html>
